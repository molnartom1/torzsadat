<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Egyszer≈± k√©szletkezel≈ë ‚Äì T√∂rzsadat + Bev√©t + Vonalk√≥d</title>
  <style>
    :root {
      --bg:#0b1220;
      --card:#020617;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2933;
      --accent:#38bdf8;
      --ok:#22c55e;
      --warn:#f97373;
      --backdrop:rgba(15,23,42,.75);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:radial-gradient(circle at top,#1d283a 0,#020617 52%);
      color:var(--ink);
    }
    .wrap{max-width:900px;margin:auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{font-size:clamp(20px,2.4vw,26px);margin:0}
    .tag{font-size:12px;color:var(--muted)}
    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 18px}
    .tabbtn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.85);
      cursor:pointer;
      font-size:14px;
      color:var(--muted);
      backdrop-filter:blur(12px);
    }
    .tabbtn.active{
      background:linear-gradient(135deg,#38bdf8,#6366f1);
      color:#fff;
      border-color:transparent;
      box-shadow:0 8px 20px rgba(56,189,248,.35);
    }
    .card{
      background:radial-gradient(circle at top left,#111827,#020617);
      border:1px solid rgba(148,163,184,.15);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 60px rgba(15,23,42,.75);
      margin-bottom:16px;
    }
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:800px){
      .grid,.grid-2{grid-template-columns:1fr}
    }
    label{font-size:13px;color:var(--muted);display:block;margin:4px 0}
    input,select,textarea{
      width:100%;
      padding:9px;
      border:1px solid rgba(148,163,184,.45);
      border-radius:12px;
      background:rgba(15,23,42,.85);
      font-size:14px;
      color:var(--ink);
    }
    input::placeholder,textarea::placeholder{color:#6b7280}
    textarea{min-height:72px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{
      padding:9px 13px;
      border-radius:999px;
      border:1px solid transparent;
      background:linear-gradient(135deg,#38bdf8,#6366f1);
      color:#fff;
      cursor:pointer;
      font-size:14px;
      box-shadow:0 10px 30px rgba(56,189,248,.45);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn.secondary{
      background:transparent;
      border-color:rgba(148,163,184,.6);
      color:var(--muted);
      box-shadow:none;
    }
    .btn.ghost{
      background:rgba(15,23,42,.9);
      border-color:rgba(148,163,184,.4);
      color:#e5e7eb;
      box-shadow:none;
    }
    .btn.small{padding:6px 11px;font-size:12px;border-radius:999px}
    .btn:focus,
    .btn:focus-visible,
    .tabbtn:focus,
    .tabbtn:focus-visible{
      outline:none;
      box-shadow:0 0 0 1px rgba(56,189,248,.6);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:560px;
    }
    thead th{
      position:sticky;
      top:0;
      background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.9));
      text-align:left;
      font-weight:500;
      font-size:12px;
      padding:8px;
      border-bottom:1px solid rgba(148,163,184,.35);
      z-index:1;
      color:#e5e7eb;
    }
    td{
      padding:8px;
      border-bottom:1px solid rgba(30,41,59,.9);
      font-size:13px;
    }
    .tablewrap{
      overflow:auto;
      max-height:420px;
      border:1px solid rgba(148,163,184,.3);
      border-radius:14px;
      background:radial-gradient(circle at top left,#020617,#020617);
    }
    .muted{color:var(--muted)}
    .error{
      background:rgba(239,68,68,.08);
      border:1px solid rgba(252,165,165,.45);
      color:#fecaca;
      padding:10px;
      border-radius:12px;
      margin-bottom:12px;
      backdrop-filter:blur(14px);
    }
    .error.info{
      background:rgba(34,197,94,.08);
      border-color:rgba(74,222,128,.45);
      color:#bbf7d0;
    }
    .hide{display:none}
    .line-row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .line-product{flex:2 1 200px;min-width:160px;}
    .line-qty{flex:0 0 80px;max-width:80px;}
    .line-unit{flex:0 0 70px;max-width:70px;}
    .line-note{flex:3 1 200px;min-width:160px;}
    .row-highlight{
      animation:flash 1.1s ease-out;
    }
    @keyframes flash{
      0%{background:rgba(234,179,8,.15);}
      100%{background:transparent;}
    }
    footer{
      text-align:center;
      font-size:12px;
      color:var(--muted);
      margin:18px 0 8px;
    }

    /* Mod√°lok ‚Äì sz√©p√≠tett beolvas√≥ ablak */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#020617 0,rgba(15,23,42,.96) 52%,rgba(15,23,42,.96) 100%);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
      backdrop-filter:blur(8px);
    }
    .modal{
      background:radial-gradient(circle at top left,#020617,#020617);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.45);
      max-width:480px;
      width:100%;
      box-shadow:0 30px 120px rgba(0,0,0,.9);
      overflow:hidden;
    }
    .modal header{
      padding:12px 18px;
      border-bottom:1px solid rgba(148,163,184,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:linear-gradient(135deg,rgba(56,189,248,.14),rgba(79,70,229,.18));
    }
    .modal h3{
      margin:0;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:8px;
      color:#e5e7eb;
    }
    .modal h3::before{
      content:"";
      width:9px;
      height:9px;
      border-radius:999px;
      background:radial-gradient(circle,#4ade80,#22c55e);
      box-shadow:0 0 14px rgba(34,197,94,.9);
    }
    .modal .content{
      padding:16px 18px 18px;
    }
    .modal footer{
      padding:10px 18px 14px;
      border-top:1px solid rgba(30,64,175,.5);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      background:radial-gradient(circle at top,#020617,#020617);
    }

    /* Sz√©p√≠tett scan ablak vide√≥kerete */
    .scan-video-wrap{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      background:radial-gradient(circle at top,#020617,#000);
      box-shadow:0 18px 55px rgba(15,23,42,.9);
    }
    #scan-video{
      width:100%;
      max-height:260px;
      display:block;
      object-fit:cover;
    }
    .scan-frame{
      position:absolute;
      inset:10%;
      border-radius:18px;
      border:2px solid rgba(248,250,252,.85);
      box-shadow:0 0 0 1px rgba(148,163,184,.35),0 0 40px rgba(56,189,248,.65);
      pointer-events:none;
      animation:frameGlow 1.4s ease-in-out infinite alternate;
    }
    .scan-corners{
      position:absolute;
      inset:10%;
      pointer-events:none;
    }
    .scan-corners::before,
    .scan-corners::after{
      content:"";
      position:absolute;
      width:26px;
      height:26px;
      border-radius:8px;
      border:3px solid rgba(56,189,248,.95);
    }
    .scan-corners::before{
      border-right:none;
      border-bottom:none;
      top:-3px;
      left:-3px;
    }
    .scan-corners::after{
      border-left:none;
      border-top:none;
      bottom:-3px;
      right:-3px;
    }
    @keyframes frameGlow{
      from{box-shadow:0 0 0 1px rgba(148,163,184,.35),0 0 26px rgba(56,189,248,.45);opacity:.96;}
      to{box-shadow:0 0 0 1px rgba(148,163,184,.7),0 0 40px rgba(56,189,248,.95);opacity:1;}
    }
    .scan-hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:flex-start;
      gap:6px;
    }
    .scan-hint-icon{
      width:16px;
      height:16px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.9);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      color:#9ca3af;
      flex-shrink:0;
    }
    .scan-footer-note{
      flex:1;
      text-align:left;
      font-size:11px;
      color:#9ca3af;
      opacity:.9;
    }

    /* MOBIL */
    @media (max-width:600px){
      .wrap { padding: 12px; }
      .tabs { gap: 4px; margin: 12px 0 18px; }
      .tabbtn { padding: 8px 10px; font-size: 14px; }
      .card { padding: 12px; border-radius: 16px; }
      h2, h3 { font-size: 18px; }
      .grid, .grid-2 { display:block; }
      .grid > div, .grid-2 > div { margin-bottom:12px; }
      input, select, textarea {
        padding: 8px;
        font-size: 15px;
        border-radius: 10px;
      }
      label { font-size: 12px; margin-bottom: 2px; }
      .line-row { flex-direction: column; align-items: stretch; }
      .line-product, .line-qty, .line-unit, .line-note {
        flex:1 1 100%;
        max-width:100%;
      }
      .line-row .btn { width:100%; margin-top:4px; }
      table {
        font-size:13px;
        min-width:520px;
      }
      thead th, td { padding:8px; }
      .tablewrap { border-radius:12px; max-height:60vh; }
      .modal{max-width:95%;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>T√∂rzsadat + Bev√©t r√∂gz√≠t≈ë</h1>
      <div class="tag">Firebase szinkron ‚Ä¢ csak bev√©t ‚Ä¢ vonalk√≥d olvas√°s</div>
    </header>

    <div class="tabs">
      <button class="tabbtn active" data-tab="bevet">Bev√©t</button>
      <button class="tabbtn" data-tab="torzs">T√∂rzsadatok</button>
    </div>

    <div id="err" class="error hide"></div>

    <!-- Bev√©t -->
    <section id="tab-bevet">
      <div class="card">
        <h2>√öj bev√©t r√∂gz√≠t√©se</h2>
        <div class="grid grid-2">
          <div>
            <label>Besz√°ll√≠t√≥</label>
            <select id="in-supplier" required></select>
          </div>
          <div>
            <label>D√°tum</label>
            <input type="date" id="in-date" required>
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Megjegyz√©s (√∂sszes sorra, opcion√°lis)</label>
          <textarea id="in-note" placeholder="Pl.: besz√°ll√≠t√≥i sz√°mlasz√°m, sof≈ër neve, stb."></textarea>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="in-add-row" class="btn ghost" type="button">+ Sor hozz√°ad√°sa</button>
          <button id="in-clear-rows" class="btn secondary" type="button">Sorok t√∂rl√©se</button>
          <div class="muted" id="in-sum"></div>
        </div>

        <div class="tablewrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="min-width:220px">Term√©k</th>
                <th style="min-width:80px">Menny.</th>
                <th style="min-width:80px">ME</th>
                <th style="min-width:220px">Megjegyz√©s (soronk√©nt, opcion√°lis)</th>
                <th style="min-width:120px">M≈±velet</th>
              </tr>
            </thead>
            <tbody id="tbody-in-rows"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="in-submit" type="button">Bev√©t r√∂gz√≠t√©se</button>
        </div>
      </div>

      <div class="card">
        <h3>Legut√≥bbi bev√©tek</h3>
        <p class="muted" style="margin-top:0;font-size:12px">
          A lista val√≥s id≈ëben friss√ºl. Csak <b>bev√©t</b> t√≠pus√∫ mozg√°sokat mutat.
        </p>
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>D√°tum</th>
                <th>Term√©k</th>
                <th>Mennyis√©g</th>
                <th>Besz√°ll√≠t√≥</th>
                <th>Megjegyz√©s</th>
              </tr>
            </thead>
            <tbody id="tbody-in-list"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- T√∂rzsadatok -->
    <section id="tab-torzs" class="hide">
      <div class="card">
        <h2>Besz√°ll√≠t√≥k</h2>
        <form id="form-sup">
          <label>N√©v</label>
          <input id="sup-name" placeholder="N√©v" required />
          <label>Megjegyz√©s</label>
          <input id="sup-note" placeholder="Megjegyz√©s (opcion√°lis)" />
          <div class="row" style="margin-top:8px">
            <button class="btn" type="submit">Hozz√°ad√°s</button>
          </div>
        </form>
        <div class="tablewrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>N√©v</th>
                <th>Megjegyz√©s</th>
              </tr>
            </thead>
            <tbody id="tbody-sup"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Megrendel≈ëk</h2>
        <p class="muted" style="margin-top:0;font-size:12px">
          Ebben a mini kliensben kiad√°s nem r√∂gz√≠thet≈ë, de az itt felvitt megrendel≈ëk
          a f≈ë rendszerben haszn√°lhat√≥k.
        </p>
        <form id="form-cus">
          <label>N√©v</label>
          <input id="cus-name" placeholder="N√©v" required />
          <label>Megjegyz√©s</label>
          <input id="cus-note" placeholder="Megjegyz√©s (opcion√°lis)" />
          <div class="row" style="margin-top:8px">
            <button class="btn" type="submit">Hozz√°ad√°s</button>
          </div>
        </form>
        <div class="tablewrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>N√©v</th>
                <th>Megjegyz√©s</th>
              </tr>
            </thead>
            <tbody id="tbody-cus"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>Term√©kek</h2>
        <form id="form-prod">
          <label>Cikksz√°m / vonalk√≥d (opcion√°lis)</label>
          <input id="prod-sku" placeholder="Cikksz√°m vagy vonalk√≥d" />
          <div class="row" style="margin:4px 0 8px;">
            <button type="button" id="prod-scan" class="btn ghost small">üì∑ K√≥d beolvas√°sa</button>
            <span class="muted" style="font-size:12px;">A beolvasott k√≥d a fenti mez≈ëbe ker√ºl.</span>
          </div>
          <label>Megnevez√©s</label>
          <input id="prod-name" placeholder="Megnevez√©s" required />
          <div class="grid grid-2">
            <div>
              <label>M√©rt√©kegys√©g</label>
              <input id="prod-unit" value="db" />
            </div>
            <div>
              <label>Min. k√©szlet (informat√≠v)</label>
              <input id="prod-min" type="number" value="0" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" type="submit">Hozz√°ad√°s</button>
          </div>
        </form>
        <div class="tablewrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Megnevez√©s</th>
                <th>R√©szletek</th>
              </tr>
            </thead>
            <tbody id="tbody-prod"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer>
      Mini kliens ‚Äì csak t√∂rzsadat √©s bev√©t (kamer√°s vonalk√≥d olvas√°s) ‚Ä¢ <span id="stamp"></span>
    </footer>
  </div>

  <!-- Vonalk√≥d / QR olvas√≥ mod√°l ‚Äì sz√©p√≠tett -->
  <div id="scan-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="scan-title">
      <header>
        <h3 id="scan-title">Vonalk√≥d / QR-k√≥d beolvas√°sa</h3>
        <button id="scan-close" class="btn secondary small" type="button">Bez√°r√°s</button>
      </header>
      <div class="content">
        <div class="scan-video-wrap">
          <video id="scan-video" autoplay muted playsinline></video>
          <div class="scan-frame"></div>
          <div class="scan-corners"></div>
        </div>
        <p class="scan-hint">
          <span class="scan-hint-icon">i</span>
          <span>Ir√°ny√≠tsd a kamer√°t a k√≥dra √∫gy, hogy a vil√°gos kereten bel√ºl legyen. Sikeres beolvas√°s ut√°n a k√≥d megjelenik fel√ºl √ºzenetk√©nt, √©s ha van ilyen term√©k, automatikusan kit√∂ltj√ºk.</span>
        </p>
      </div>
      <footer>
        <div class="scan-footer-note">
          √âl≈ë kamera-el≈ën√©zet ‚Ä¢ Az adatokat csak a k√©sz√ºl√©keden dolgozzuk fel
        </div>
        <button id="scan-cancel" class="btn ghost small" type="button">M√©gse</button>
      </footer>
    </div>
  </div>

  <!-- √öj term√©k mod√°l (ismeretlen vonalk√≥d eset√©n, bev√©t sorb√≥l) -->
  <div id="product-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="product-title">
      <header>
        <h3 id="product-title">√öj term√©k a beolvasott k√≥ddal</h3>
      </header>
      <div class="content">
        <label>Beolvasott k√≥d</label>
        <input id="prod-modal-sku" readonly />
        <label>Megnevez√©s</label>
        <input id="prod-modal-name" placeholder="Pl.: Mos√≥szer 5L" />
        <label>M√©rt√©kegys√©g</label>
        <input id="prod-modal-unit" value="db" />
        <p class="muted" style="font-size:12px;margin-top:8px;">
          Ment√©s ut√°n a term√©k beker√ºl a t√∂rzsadatok k√∂z√©, √©s r√∂gt√∂n kiv√°laszt√°sra ker√ºl a sorban.
        </p>
      </div>
      <footer>
        <button id="prod-modal-cancel" class="btn ghost small" type="button">M√©gse</button>
        <button id="prod-modal-ok" class="btn small" type="button">Ment√©s</button>
      </footer>
    </div>
  </div>

  <script>
    (function(){
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      window.showErr = function(msg, kind){
        const e = $('#err');
        if(!e) return;
        e.textContent = String(msg || 'Ismeretlen hiba');
        e.classList.remove('hide','info');
        if(kind === 'info') e.classList.add('info');
      };
      window.hideErr = function(){
        const e = $('#err');
        if(!e) return;
        e.classList.add('hide');
        e.classList.remove('info');
      };

      const stampEl = document.getElementById('stamp');
      if(stampEl){
        const d = new Date();
        stampEl.textContent = d.toISOString().slice(0,19).replace('T',' ');
      }

      $$('.tabbtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$('.tabbtn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const id = btn.getAttribute('data-tab');
          ['bevet','torzs'].forEach(t=>{
            const sec = document.getElementById('tab-'+t);
            if(sec) sec.classList.toggle('hide', t!==id);
          });
        });
      });
    })();
  </script>

  <!-- ZXing (vonalk√≥d/QR olvas√≥) -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import {
      getFirestore, collection, addDoc, onSnapshot, serverTimestamp,
      query, orderBy, enableIndexedDbPersistence
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
      authDomain: "mosas-nyilvantartas.firebaseapp.com",
      projectId: "mosas-nyilvantartas",
      storageBucket: "mosas-nyilvantartas.appspot.com",
      messagingSenderId: "38259241645",
      appId: "1:38259241645:web:26070b1d0686def9f00c24"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const db = getFirestore();
    enableIndexedDbPersistence(db).catch(()=>{});

    const auth = getAuth();
    onAuthStateChanged(auth, (user)=>{
      if(!user){
        signInAnonymously(auth).catch(e=>showErr('Anonim bejelentkez√©s hiba: '+(e?.message||e)));
      }
    });

    const COL_SUPPLIERS = 'mosas_suppliers';
    const COL_CUSTOMERS = 'mosas_customers';
    const COL_PRODUCTS  = 'mosas_products';
    const COL_MOVEMENTS = 'mosas_movements';

    let suppliers = [], customers = [], products = [], movements = [];

    const $ = (sel) => document.querySelector(sel);
    const fmt = new Intl.NumberFormat('hu-HU', { maximumFractionDigits: 2 });

    // == Realtime szinkron ==
    onSnapshot(query(collection(db, COL_SUPPLIERS), orderBy('name')), (snap)=>{
      suppliers = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderSuppliers();
      fillPartners();
    });

    onSnapshot(query(collection(db, COL_CUSTOMERS), orderBy('name')), (snap)=>{
      customers = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderCustomers();
    });

    onSnapshot(query(collection(db, COL_PRODUCTS), orderBy('name')), (snap)=>{
      products = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderProducts();
      fillProducts();
    });

    // Csak bev√©t t√≠pus√∫ mozg√°sok list√°z√°sa
    onSnapshot(query(collection(db, COL_MOVEMENTS), orderBy('ts','desc')), (snap)=>{
      movements = snap.docs.map(d=>({id:d.id, ...d.data()}))
        .filter(m=>m.type === 'in');
      renderInList();
    });

    // == T√∂rzsadat ≈±rlapok ==
    document.getElementById('form-sup').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('sup-name').value.trim();
      const note = document.getElementById('sup-note').value.trim();
      if(!name) return showErr('Adj meg nevet a besz√°ll√≠t√≥nak!');
      try{
        await addDoc(collection(db, COL_SUPPLIERS), { name, note });
        e.target.reset();
        hideErr();
      }catch(err){
        showErr('Besz√°ll√≠t√≥ ment√©se sikertelen: ' + (err?.message||err));
      }
    });

    document.getElementById('form-cus').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('cus-name').value.trim();
      const note = document.getElementById('cus-note').value.trim();
      if(!name) return showErr('Adj meg nevet a megrendel≈ënek!');
      try{
        await addDoc(collection(db, COL_CUSTOMERS), { name, note });
        e.target.reset();
        hideErr();
      }catch(err){
        showErr('Megrendel≈ë ment√©se sikertelen: ' + (err?.message||err));
      }
    });

    document.getElementById('form-prod').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const sku  = document.getElementById('prod-sku').value.trim();
      const name = document.getElementById('prod-name').value.trim();
      const unit = document.getElementById('prod-unit').value.trim() || 'db';
      const min  = Number(document.getElementById('prod-min').value||0);
      if(!name) return showErr('Adj meg megnevez√©st a term√©knek!');
      try{
        await addDoc(collection(db, COL_PRODUCTS), {
          sku, name, unit, min: isNaN(min)?0:min
        });
        e.target.reset();
        hideErr();
      }catch(err){
        showErr('Term√©k ment√©se sikertelen: ' + (err?.message||err));
      }
    });

    // == Bev√©t sorok ==
    const inRowsTbody = document.getElementById('tbody-in-rows');

    document.getElementById('in-add-row').addEventListener('click', ()=>{
      addLineRow();
    });
    document.getElementById('in-clear-rows').addEventListener('click', ()=>{
      inRowsTbody.innerHTML = '';
      updateSum();
    });

    function addLineRow(){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td colspan="5">
          <div class="line-row">
            <select class="li-product line-product" required></select>
            <input class="li-qty line-qty" type="number" min="0.01" step="0.01" value="1" required />
            <input class="li-unit line-unit" />
            <input class="li-note line-note" placeholder="Megjegyz√©s (opcion√°lis)" />
            <button type="button" class="btn ghost small li-scan">üì∑ Olvas√°s</button>
            <button type="button" class="btn secondary small li-del">T√∂r√∂l</button>
          </div>
        </td>`;
      inRowsTbody.appendChild(tr);
      const sel = tr.querySelector('.li-product');
      const unitInput = tr.querySelector('.li-unit');
      fillRowProducts(sel, unitInput);

      tr.querySelector('.li-qty').addEventListener('input', updateSum);
      tr.querySelector('.li-del').addEventListener('click', ()=>{
        tr.remove();
        updateSum();
      });

      const scanBtn = tr.querySelector('.li-scan');
      scanBtn.addEventListener('click', ()=>{
        startScan(code => applyScanToRow(code, tr));
      });

      updateSum();
    }

    function fillRowProducts(sel, unitInput){
      const opts = ['<option value="">‚Äì v√°lassz ‚Äì</option>'].concat(
        products.map(p=>`<option value="${p.id}">${p.sku? esc(p.sku)+' ‚Äì ' : ''}${esc(p.name)}</option>`)
      ).join('');
      sel.innerHTML = opts;
      sel.addEventListener('change', ()=>{
        const p = getProduct(sel.value);
        unitInput.value = p?.unit || 'db';
      }, { once:true });
    }

    function updateSum(){
      const sum = Array.from(inRowsTbody.querySelectorAll('.li-qty'))
        .reduce((s,el)=> s + (Number(el.value)||0), 0);
      document.getElementById('in-sum').textContent =
        sum>0 ? `√ñsszes mennyis√©g: ${fmt.format(sum)}` : '';
    }

    function fillProducts(){
      [...document.querySelectorAll('.li-product')].forEach(sel=>{
        const unitInput = sel.closest('tr').querySelector('.li-unit');
        fillRowProducts(sel, unitInput);
      });
    }

    function fillPartners(){
      document.getElementById('in-supplier').innerHTML =
        ['<option value="">‚Äì v√°lassz ‚Äì</option>'].concat(
          suppliers.map(s=>`<option value="${s.id}">${esc(s.name)}</option>`)
        ).join('');
    }

    // == Bev√©t ment√©s ==
    document.getElementById('in-submit').addEventListener('click', async ()=>{
      hideErr();
      const supplierId = document.getElementById('in-supplier').value;
      const date = document.getElementById('in-date').value;
      const globalNote = document.getElementById('in-note').value.trim();
      const rows = Array.from(inRowsTbody.querySelectorAll('tr'));
      if(!supplierId) return showErr('V√°lassz besz√°ll√≠t√≥t!');
      if(!date) return showErr('Adj meg d√°tumot!');
      if(!rows.length) return showErr('Adj hozz√° legal√°bb egy sort a bev√©thez!');

      const docs = [];
      for(const tr of rows){
        const productSel = tr.querySelector('.li-product');
        const qtyInput   = tr.querySelector('.li-qty');
        const unitInput  = tr.querySelector('.li-unit');
        const noteInput  = tr.querySelector('.li-note');

        const productId = productSel.value;
        const qty = Number(qtyInput.value||0);
        if(!productId || !qty || qty<=0){
          return showErr('Minden sorban v√°lassz term√©ket √©s adj meg pozit√≠v mennyis√©get!');
        }
        const unit = unitInput.value.trim() || (getProduct(productId)?.unit || 'db');
        const note = [globalNote, noteInput.value.trim()].filter(Boolean).join(' | ');

        docs.push({
          type: 'in',
          productId,
          qty,
          unit,
          partnerId: supplierId,
          note,
          stamp: date + ' ' + new Date().toTimeString().slice(0,8),
          ts: serverTimestamp()
        });
      }

      try{
        for(const d of docs){
          await addDoc(collection(db, COL_MOVEMENTS), d);
        }
        inRowsTbody.innerHTML = '';
        updateSum();
        showErr('Bev√©t r√∂gz√≠tve.', 'info');
      }catch(err){
        showErr('Bev√©t r√∂gz√≠t√©se sikertelen: ' + (err?.message||err));
      }
    });

    // == List√°k ==
    function renderSuppliers(){
      const tb = document.getElementById('tbody-sup');
      tb.innerHTML = '';
      suppliers.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(s.name)}</td>
          <td class="muted">${esc(s.note||'')}</td>`;
        tb.appendChild(tr);
      });
    }

    function renderCustomers(){
      const tb = document.getElementById('tbody-cus');
      tb.innerHTML = '';
      customers.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(c.name)}</td>
          <td class="muted">${esc(c.note||'')}</td>`;
        tb.appendChild(tr);
      });
    }

    function renderProducts(){
      const tb = document.getElementById('tbody-prod');
      tb.innerHTML = '';
      products.forEach(p=>{
        const details = [
          p.sku||'',
          p.unit?`ME: ${p.unit}`:'',
          (p.min||0)>0?`min: ${p.min}`:''
        ].filter(Boolean).join(' ‚Ä¢ ');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(p.name)}</td>
          <td class="muted">${esc(details)}</td>`;
        tb.appendChild(tr);
      });
    }

    function renderInList(){
      const tb = document.getElementById('tbody-in-list');
      tb.innerHTML = '';
      movements.slice(0,50).forEach(m=>{
        const p = getProduct(m.productId);
        const partner = suppliers.find(s=>s.id===m.partnerId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(m.stamp||'‚Äì')}</td>
          <td>${esc(p? p.name : m.productId)}</td>
          <td>${fmt.format(m.qty)} ${esc(m.unit || (p?.unit||'db'))}</td>
          <td>${esc(partner? partner.name : '‚Äì')}</td>
          <td>${esc(m.note||'')}</td>`;
        tb.appendChild(tr);
      });
    }

    // == Vonalk√≥d olvas√°s (egyszer≈± callback rendszerrel) ==
    const scanBackdrop = document.getElementById('scan-backdrop');
    const scanClose = document.getElementById('scan-close');
    const scanCancel = document.getElementById('scan-cancel');

    let codeReader = null;

    function startScan(onCode){
      if(!window.ZXing || !window.ZXing.BrowserMultiFormatReader){
        showErr('A vonalk√≥d olvas√≥ k√∂nyvt√°r nem t√∂lt≈ëd√∂tt be.');
        return;
      }
      const Reader = window.ZXing.BrowserMultiFormatReader;
      codeReader = new Reader();
      scanBackdrop.style.display = 'flex';

      try{
        codeReader.decodeFromVideoDevice(null, 'scan-video', (result, err)=>{
          if(result){
            const text = result.getText();
            showErr('Beolvasott k√≥d: ' + text, 'info');
            try{
              if(onCode) onCode(text);
            }catch(e){
              showErr('A beolvasott k√≥d feldolgoz√°s√°n√°l hiba t√∂rt√©nt: ' + (e?.message||e));
            }
            stopScan();
          }
        });
      }catch(e){
        showErr('Nem siker√ºlt elind√≠tani a kamer√°t: ' + (e?.message||e));
        stopScan();
      }
    }

    function stopScan(){
      try{
        if(codeReader){
          codeReader.reset();
          codeReader = null;
        }
      }catch{}
      scanBackdrop.style.display = 'none';
    }

    scanClose.addEventListener('click', stopScan);
    scanCancel.addEventListener('click', stopScan);

    async function applyScanToRow(code, tr){
      if(!code) return;
      const sel = tr.querySelector('.li-product');
      const unitInput = tr.querySelector('.li-unit');
      let p = products.find(p=>String(p.sku||'') === String(code));
      if(p){
        sel.value = p.id;
        unitInput.value = p.unit || 'db';
        tr.classList.remove('row-highlight');
        void tr.offsetWidth;
        tr.classList.add('row-highlight');
        tr.scrollIntoView({ behavior:'smooth', block:'center' });
        return;
      }
      const res = await openProductModal(code);
      if(!res) return;
      try{
        const ref = await addDoc(collection(db, COL_PRODUCTS), {
          sku: code,
          name: res.name,
          unit: res.unit || 'db',
          min: 0
        });
        sel.value = ref.id;
        unitInput.value = res.unit || 'db';
        tr.classList.remove('row-highlight');
        void tr.offsetWidth;
        tr.classList.add('row-highlight');
        tr.scrollIntoView({ behavior:'smooth', block:'center' });
      }catch(e){
        showErr('√öj term√©k ment√©se sikertelen: ' + (e?.message||e));
      }
    }

    const productBackdrop = document.getElementById('product-backdrop');
    const prodModalSku = document.getElementById('prod-modal-sku');
    const prodModalName = document.getElementById('prod-modal-name');
    const prodModalUnit = document.getElementById('prod-modal-unit');
    const prodModalOk = document.getElementById('prod-modal-ok');
    const prodModalCancel = document.getElementById('prod-modal-cancel');

    function openProductModal(sku){
      prodModalSku.value = sku || '';
      prodModalName.value = '';
      prodModalUnit.value = 'db';
      productBackdrop.style.display = 'flex';

      return new Promise(resolve=>{
        function close(res){
          productBackdrop.style.display = 'none';
          prodModalOk.removeEventListener('click', onOk);
          prodModalCancel.removeEventListener('click', onCancel);
          document.removeEventListener('keydown', onKey);
          resolve(res);
        }
        function onOk(){
          const name = prodModalName.value.trim() || sku || '';
          const unit = prodModalUnit.value.trim() || 'db';
          close({ name, unit });
        }
        function onCancel(){ close(null); }
        function onKey(e){
          if(e.key === 'Escape') onCancel();
          if(e.key === 'Enter') onOk();
        }
        prodModalOk.addEventListener('click', onOk);
        prodModalCancel.addEventListener('click', onCancel);
        setTimeout(()=> document.addEventListener('keydown', onKey), 0);
        setTimeout(()=> prodModalName.focus(), 50);
      });
    }

    // === T√∂rzsadat f√ºl vonalk√≥d olvas√°s (3-as opci√≥) ===
    const prodScanBtn = document.getElementById('prod-scan');
    if(prodScanBtn){
      prodScanBtn.addEventListener('click', ()=>{
        startScan(handleProductScan);
      });
    }

    async function handleProductScan(code){
      if(!code) return;
      const skuInput = document.getElementById('prod-sku');
      const nameInput = document.getElementById('prod-name');
      const unitInput = document.getElementById('prod-unit');

      skuInput.value = code;

      const existing = products.find(p=>String(p.sku||'') === String(code));
      if(existing){
        const msg =
`M√°r l√©tezik term√©k ezzel a k√≥ddal:

${existing.name} (${existing.unit || 'db'})

OK: bet√∂lt√∂m az adatait (szerkesztheted is)
M√©gse: csak a k√≥d marad, √∫j term√©kk√©nt viheted fel.`;
        if(confirm(msg)){
          nameInput.value = existing.name || '';
          unitInput.value = existing.unit || 'db';
          nameInput.focus();
          return;
        } else {
          nameInput.value = '';
          unitInput.value = 'db';
          nameInput.focus();
          return;
        }
      } else {
        nameInput.value = '';
        unitInput.value = 'db';
        nameInput.focus();
      }
    }

    // Helper f√ºggv√©nyek
    function getProduct(id){ return products.find(p=>p.id===id); }
    function esc(s){
      return String(s||'').replace(/[&<>"']/g, c=>({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        '"':"&quot;"
      }[c]||c));
    }

  </script>
</body>
</html>
